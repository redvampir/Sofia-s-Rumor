# Орган Слуха v0.1

## 1. Обзор (Overview)
- **Что это:** внешний модуль/плагин, который получает аудио (файл или поток), анализирует базовые музыкальные и речевые характеристики и отдаёт ИИ-агенту структурированное описание трека. Работает в экосистеме Нейра/София как «орган слуха» рядом с органом Музыки и Ритма.
- **Задачи:**
  - анализ музыки/звука по файлу или стриму;
  - формирование структурированного описания трека (темп, тональность, динамика, структура, настроение) для ИИ;
  - передача данных в орган Музыки и Ритма, который оперирует текстом/сценами.
- **Чего не делает:**
  - не синтезирует звук и не генерирует аранжировки;
  - не заменяет DAW и не проводит детальный мастеринговый анализ;
  - не выполняет авторские права/идентификацию контента (Shazam-подобные функции не входят в v0.1).

## 2. Основные сценарии использования (Use Cases)
1) **Автор даёт трек → ИИ описывает настроение и темп и подбирает ритм текста.**
   - Вход: аудиофайл музыки (mp3/wav/flac), `mode="music"`, `need_sections=true`, `need_mood=true`.
   - Выход: JSON с BPM, тональностью, размером, mood tags, энергией, яркостью, длительностью, секциями куплет/припев.
   - Использование ИИ: орган Музыки и Ритма подбирает ритм и размер текстовых строк, формирует описание настроения для автора.

2) **Пользователь прикладывает фоновую музыку → Нейра настраивает под неё темп сцен.**
   - Вход: аудиофайл/ссылка, `mode="auto"`, `need_sections=false`, `need_mood=true`.
   - Выход: JSON с BPM, размером, энергией, яркостью, mood tags, длительностью.
   - Использование ИИ: рассчитывает длительность сцен, распределяет кульминации по пикам энергии.

3) **Анализ подкаста/речи → базовые параметры без музыкальной гармонии.**
   - Вход: аудиофайл речи, `mode="speech"`, `need_sections=false`, `need_mood=false`.
   - Выход: JSON с долей речи, паузами (silence segments), средней/пиковой громкостью, длительностью; BPM/тональность могут быть `null` или опущены.
   - Использование ИИ: определяет темп повествования, места для вставок, оценивает динамику речи.

## 3. Модель данных анализа аудио (Data Model)
Результат — JSON-объект. Типы и диапазоны указаны для валидации и интерпретации.

### Общие поля
- `bpm` (number, ≥0): оценка темпа (beats per minute). Для речи может быть `null`.
- `bpm_confidence` (number, 0–1): уверенность детектора темпа. В музыке <0.5 означает, что ритмика слабая/спорная; в речи низкое значение допускается и служит сигналом не выдумывать BPM.
- `time_signature` (string): размер, формат "4/4", "3/4", "6/8"; если не обнаружен — `null`; может быть опущен в ответе.
- `key` (string): тональность, формат `"Am"`, `"C#maj"`, `"Fmin"`; `null`, если не определена.
- `key_confidence` (number, 0–1): уверенность в определении тональности. Для речи и шумной среды ожидаемо низкая; при значении <0.5 трактуем тональность как эвристику.
- `energy` (number, 0–1): субъективная напряжённость/динамика трека.
- `brightness` (number, 0–1): относительная «яркость» (доля ВЧ/сибилянтов).
- `mood_tags` (string[]): список тегов настроения, 0–8 элементов, например `["melancholic", "dreamy"]`.
- `duration_sec` (number, >0): длительность аудио в секундах.
- `analysis_status` (string): итоговое состояние анализа: `"ok"` (полноценный), `"degraded"` (частично эвристический/неполный результат), `"failed"` (анализ не выполнен, поля могут быть `null`). Для музыки `degraded` сигнализирует о слабой ритмике/тональности, для речи — о невозможности извлечь устойчивые музыкальные параметры.

### Структура трека
- `sections` (array): список структурированных частей; пустой массив, если не запрошено или не обнаружено.
  - `type` (string): "intro" | "verse" | "chorus" | "bridge" | "outro" | "drop" | "unknown".
  - `start_sec` (number, ≥0): начало секции.
  - `end_sec` (number, >start_sec): конец секции.
  - `energy` (number, 0–1, optional): локальная оценка энергии секции.
  - `mood_tags` (string[], optional): настроение секции.
  - `section_confidence` (number, 0–1, optional): уверенность в сегментации. Для треков с явной структурой >0.6; при речи или амбиенте значения ниже 0.5 означают, что секции эвристические.

### Речь/подкасты (опциональные поля)
- `speech_ratio` (number, 0–1): доля времени с речью.
- `silence_segments` (array): паузы в секундах.
  - элементы: `{ "start_sec": number ≥0, "end_sec": number > start_sec }`.
- `avg_loudness` (number, dBFS): средний уровень громкости.
- `max_loudness` (number, dBFS): пиковый уровень громкости.

### Пример JSON-схемы (упрощённо)
```json
{
  "bpm": 122.4,
  "bpm_confidence": 0.82,
  "time_signature": "4/4",
  "key": "Am",
  "key_confidence": 0.77,
  "energy": 0.73,
  "brightness": 0.58,
  "mood_tags": ["dreamy", "melancholic"],
  "duration_sec": 214.2,
  "analysis_status": "ok",
  "sections": [
    {"type": "intro", "start_sec": 0.0, "end_sec": 12.5, "energy": 0.35, "section_confidence": 0.7},
    {"type": "verse", "start_sec": 12.5, "end_sec": 52.0, "energy": 0.55, "section_confidence": 0.8},
    {"type": "chorus", "start_sec": 52.0, "end_sec": 82.0, "energy": 0.78, "mood_tags": ["uplifting"], "section_confidence": 0.72}
  ],
  "speech_ratio": null,
  "silence_segments": [],
  "avg_loudness": -14.2,
  "max_loudness": -1.2
}
```

## 4. API / эндпоинты органа слуха
Сервисный слой — HTTP JSON. Все ответы `application/json; charset=utf-8`. Ошибки — стандартные коды (400 валидация, 404 файл не найден, 500 внутренняя ошибка).

### 4.1. `POST /audio/analyze`
- Назначение: анализ одного аудиофайла.
- Вход:
  - `audio_file` (multipart/form-data) **или** `audio_url` (string, HTTPS);
  - опциональные параметры (JSON-поля формы или query):
    - `mode`: `"music" | "speech" | "auto"` (default: `"auto"`);
    - `need_sections`: boolean (default: true);
    - `need_mood`: boolean (default: true).
- Выход: JSON по модели данных.

**Пример запроса (multipart)**
```
POST /audio/analyze
Content-Type: multipart/form-data; boundary=---X
---X
Content-Disposition: form-data; name="audio_file"; filename="track.mp3"
Content-Type: audio/mpeg
<байты файла>
---X
Content-Disposition: form-data; name="mode"
"music"
---X--
```

**Пример ответа**
```json
{
  "bpm": 128.0,
  "bpm_confidence": 0.76,
  "time_signature": "4/4",
  "key": "C#maj",
  "key_confidence": 0.71,
  "energy": 0.81,
  "brightness": 0.66,
  "mood_tags": ["energetic", "bright"],
  "duration_sec": 189.6,
  "analysis_status": "ok",
  "sections": [
    {"type": "intro", "start_sec": 0, "end_sec": 10.5, "section_confidence": 0.65},
    {"type": "verse", "start_sec": 10.5, "end_sec": 42.0, "section_confidence": 0.78},
    {"type": "chorus", "start_sec": 42.0, "end_sec": 72.0, "section_confidence": 0.75},
    {"type": "bridge", "start_sec": 120.0, "end_sec": 138.0, "section_confidence": 0.6},
    {"type": "outro", "start_sec": 168.0, "end_sec": 189.6, "section_confidence": 0.62}
  ],
  "speech_ratio": null,
  "silence_segments": [],
  "avg_loudness": -13.0,
  "max_loudness": -0.8
}
```

### 4.2. `GET /audio/health`
- Назначение: проверка работоспособности сервиса.
- Выход: `{ "status": "ok" | "degraded" | "error", "details": string }`.

**Пример ответа**
```json
{ "status": "ok", "details": "ready" }
```

#### Ошибки и лимиты
- Поддерживаемые коды ошибок:
  - `400` — валидация входных данных или отсутствует обязательный параметр.
  - `404` — ресурс не найден (например, ссылка недоступна или аудио удалено).
  - `413` — превышен максимальный размер файла.
  - `415` — неподдерживаемый формат контента (Content-Type или расширение файла).
  - `429` — превышены лимиты запросов, повторите позже.
  - `500` — внутренняя ошибка сервиса.
- Формат тела ошибки (application/json):
  ```json
  { "error": { "code": "...", "message": "...", "details": {} } }
  ```
  - `code` — машинно-читаемый код (например, `VALIDATION_FAILED`, `NOT_FOUND`, `RATE_LIMITED`, `INTERNAL_ERROR`).
  - `message` — человеко-читаемое описание.
  - `details` — объект с дополнительными данными (например, название недостающего поля или тип ограничения).
- Максимальный размер файла: до 50 МБ или длительность до 15 минут; превышение приводит к `413`.
- Тайм-аут обработки: запрос отклоняется после 60 секунд совокупной обработки; сервер возвращает `500` с кодом `TIMEOUT`.
- Ретраи: допускаются только для `429` и `500` при идемпотентных запросах с экспоненциальной задержкой (например, 1с → 2с → 4с), не более 3 попыток.
- Идемпотентность: повторные запросы с одинаковым файлом/URL и параметрами должны выдавать тот же результат; при изменении содержимого ответа может отличаться.
- Заголовок версии API: передавайте `X-API-Version: v0.1`; при несовпадении сервер может вернуть `400`.

### 4.3. (Опционально) `POST /audio/analyze/batch`
- Назначение: пакетный анализ нескольких файлов по ссылкам.
- Вход: `{ "items": [{ "audio_url": "https://...", "mode": "auto" }], "need_sections": true, "need_mood": true }`.
- Выход: `{ "results": [ { "audio_url": "...", "analysis": <JSON-модель или error> } ] }`.

## 5. Интеграция с ИИ-агентом (Нейра/София)
- Шаги использования:
  1. Агент получает аудио от пользователя.
  2. Вызывает `/audio/analyze` с подходящим `mode`.
  3. Получает JSON и передаёт в орган Музыки и Ритма.
  4. Агент:
     - генерирует человеческое описание трека (BPM/тональность/настроение простыми словами);
     - предлагает ритм и темп текста или сцен, синхронизирует кульминации с пиками энергии;
     - поясняет соответствие «звук ↔ текст/сцена» (например, «припев — там же делаем эмоциональный пик»).
- Что ИИ не должен делать:
  - не «придумывать», что слышит аудио, если анализ не выполнен или вернулась ошибка;
  - не выдумывать параметры трека при отсутствии данных; в ответах явно говорить об ошибке анализа.

## 6. Ограничения и допущения (Limitations)
- Оценки энергии и настроения вероятностные, зависят от обучающих данных — не считать их абсолютной истиной. Поля `*_confidence` сигнализируют, когда детектор не уверен: при значениях <0.5 данные считаются эвристическими; агент обязан явно указать на низкую уверенность и предлагать осторожные действия (например, подбирать темп вручную, опираться на громкость/паузы вместо тональности).
- Поддерживаемые форматы v0.1: стерео/моно, 16-bit PCM или сжатые (mp3/aac/ogg), длительность ≤ 15 минут, частота дискретизации 44.1/48 кГц.
- Шумный микс речи и музыки: режим `auto` пытается разделить, но точность ниже; в JSON возможны `null` для тональности/BPM и низкая уверенность mood. В таких случаях выставляем `analysis_status="degraded"` и удерживаем поля с низкими `*_confidence`. Агент должен: прямо сообщать, что выводы эвристические, не придумывать точные значения, опираться на устойчивые показатели (длительность, пики громкости).
- При отсутствии явной ритмики (эмбиент, подкасты) BPM может быть неопределён (`null`); агенту следует трактовать `analysis_status="degraded"` как сигнал не выдумывать ритм, использовать структуру/паузу/громкость.
- Размер (time signature) — эвристический, для сложных полиритмов точность ограничена; при сомнениях поле может отсутствовать, а статус быть `degraded`.
- Если анализ полностью провалился (битый файл, неподдерживаемый формат) — `analysis_status="failed"`, все метрики `null`, агент обязан сообщить об ошибке вместо выдумывания значений.

**Возможные улучшения для v0.2+:**
- Поддержка многоканальных треков и битовых глубин выше 16-bit.
- Уточнение тональности с учётом модальных/ладовых отклонений.
- Эмоции по вокалу (sad/angry/happy) и детекция жанра.
- Построение кривых динамики/энергии по времени и авто-детект переходов.
- Улучшенная сегментация для сложных структур (EDM build-ups, дропы, двойные припевы).

## 7. Примеры использования (Examples)
1) **Лиричный инди-трек с умеренным темпом.**
   - Вход: описание «гитара, лёгкий бит, женский вокал, темп ~110 BPM». Анализ выдаёт:
   ```json
   {
     "bpm": 109.5,
     "bpm_confidence": 0.74,
     "time_signature": "4/4",
     "key": "Gmaj",
     "key_confidence": 0.69,
     "energy": 0.52,
     "brightness": 0.41,
     "mood_tags": ["melancholic", "dreamy"],
     "duration_sec": 202.0,
     "analysis_status": "ok",
     "sections": [
       {"type": "intro", "start_sec": 0, "end_sec": 8, "section_confidence": 0.68},
       {"type": "verse", "start_sec": 8, "end_sec": 48, "section_confidence": 0.73},
       {"type": "chorus", "start_sec": 48, "end_sec": 78, "section_confidence": 0.7}
     ],
     "speech_ratio": null,
     "silence_segments": [],
     "avg_loudness": -15.0,
     "max_loudness": -1.5
   }
   ```
   - Использование ИИ: предлагает ритм текста 4/4 с мягкими паузами, делает эмоциональный подъём в разделе, соответствующем припеву.

2) **Электронный трек для динамичной сцены.**
   - Вход: «клубный бит, синты, быстрый темп». Анализ:
   ```json
   {
     "bpm": 132.0,
     "bpm_confidence": 0.79,
     "time_signature": "4/4",
     "key": "Dm",
     "key_confidence": 0.75,
     "energy": 0.82,
     "brightness": 0.74,
     "mood_tags": ["energetic", "tense"],
     "duration_sec": 180.0,
     "analysis_status": "ok",
     "sections": [
       {"type": "intro", "start_sec": 0, "end_sec": 12, "section_confidence": 0.64},
       {"type": "verse", "start_sec": 12, "end_sec": 45, "section_confidence": 0.81},
       {"type": "chorus", "start_sec": 45, "end_sec": 75, "section_confidence": 0.77},
       {"type": "drop", "start_sec": 90, "end_sec": 110, "section_confidence": 0.69},
       {"type": "outro", "start_sec": 150, "end_sec": 180, "section_confidence": 0.62}
     ],
     "speech_ratio": null,
     "silence_segments": [],
     "avg_loudness": -10.5,
     "max_loudness": -0.5
   }
   ```
   - Использование ИИ: синхронизирует кульминацию сюжета с дропом, темп текста держит в районе 132 BPM, избегая длинных пауз.

3) **Подкаст с интервью.**
   - Вход: «два ведущих, 45 минут, есть паузы и смех». Анализ:
   ```json
   {
     "bpm": null,
     "bpm_confidence": null,
     "time_signature": null,
     "key": null,
     "key_confidence": null,
     "energy": 0.38,
     "brightness": 0.36,
     "mood_tags": ["informative"],
     "duration_sec": 2700.0,
     "analysis_status": "degraded",
     "sections": [],
     "speech_ratio": 0.92,
     "silence_segments": [
       {"start_sec": 300, "end_sec": 307},
       {"start_sec": 1800, "end_sec": 1804}
     ],
     "avg_loudness": -19.0,
     "max_loudness": -2.0
   }
   ```
   - Использование ИИ: ставит рекламные вставки в большие паузы, не опирается на BPM/тональность, но использует энергию/громкость для подстройки тона ответов.

---

Комментарий циничного ассистента:
- Хотите, чтобы ИИ «слышал» без ушей? Без этого органа он бы просто фантазировал.
- Сегментацию куплетов всё равно будете подкручивать руками — но хоть базу дал.
- Если решите скормить органу двухчасовой шумный подкаст, не удивляйтесь `null` вместо тональности.
